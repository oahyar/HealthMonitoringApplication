<!DOCTYPE html>
<html lang="en">
<head>
    <title>Health Monitoring</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<!-- ✅ Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">Health Monitoring</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard">Disk Space</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/status-summary">Job Status</a>
                </li>
                <!-- Add more nav items here if needed -->
            </ul>
        </div>
    </div>
</nav>
<div class="container mt-3">
    <h2>Job Status Dashboard</h2>
    <div class="d-flex align-items-center gap-2">
        <!-- ✅ Refresh Button -->
        <a id="refresh-btn" href="/status-summary" class="btn btn-primary">Refresh</a>
        <p id="last-refresh" class="mb-0">Last Refreshed: --</p>
    </div>
    <table class="table table-dark mt-3">
        <thead>
        <tr>
            <th>Job Name</th>
            <th>Status</th>
            <th>Last Run Time</th>
            <th>Next Run Time</th>
            <th>History</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="job : ${jobs}">
            <td th:text="${job.jobName}"></td>
            <td th:text="${job.lastStatus}"></td>
            <td th:text="${job.lastRunTime}"></td>
            <td th:text="${job.nextRunTime}"></td>
            <td>
                <button type="button" class="btn btn-primary retrieve-data-btn">
                    More Details
                </button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- ✅ Modal for Showing Details -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitle">Details</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-dark">
                    <thead id="modalTableHead">
                    </thead>
                    <tbody id="modalTableBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('.retrieve-data-btn');

        buttons.forEach(button => {
            button.addEventListener('click', function () {
                const jobName = this.closest('tr').querySelector('td').innerText; // Get job name from first <td>

                fetch(`/history/${jobName}`)
                    .then(response => response.json())
                    .then(data => {
                        // Set modal title
                        document.getElementById('modalTitle').innerText = `Run History for ${jobName}`;

                        // Build table header
                        const headHtml = `
                        <tr>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Status</th>
                        </tr>`;
                        document.getElementById('modalTableHead').innerHTML = headHtml;

                        // Build table body
                        const bodyHtml = data.map(log => `
                        <tr>
                            <td>${log.startTime || '-'}</td>
                            <td>${log.endTime || '-'}</td>
                            <td>${log.status}</td>
                        </tr>
                    `).join('');
                        document.getElementById('modalTableBody').innerHTML = bodyHtml;

                        // Show the modal
                        const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                        modal.show();
                    });
            });
        });
    });

    // Refresh button last update time
    function updateLastRefreshTime() {
        // Get the current UTC time
        const now = new Date();

        // Convert UTC to Singapore Time (UTC+8)
        const options = { timeZone: 'Asia/Singapore', year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };

        const formattedTime = new Intl.DateTimeFormat('en-GB', options).format(now).replace(',', '');

        // Update the UI with the new timestamp
        document.getElementById('last-refresh').innerText = `Last Refreshed: ${formattedTime} SGT`;
    }

    // Attach event listener to refresh button
    document.getElementById('refresh-btn').addEventListener('click', updateLastRefreshTime);

    // Set initial refresh time when the page loads
    updateLastRefreshTime();
</script>
</body>
</html>