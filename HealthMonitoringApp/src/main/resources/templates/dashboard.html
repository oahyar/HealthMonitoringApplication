<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Health Monitoring Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- ✅ Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/disk">Health Monitoring</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/disk">Disk Space</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/status-summary">Job Status</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/api-summary">API Status</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/dashboard">Dashboard</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row gy-4">
        <!-- Disk Space Chart -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm rounded">
                <!-- Header with icon -->
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <i class="bi bi-server-fill fs-5 me-2"></i>
                    <span class="fs-6 mb-0">Server &amp; Database Alerts</span>
                </div>

                <!-- List group of alert links -->
                <div class="list-group list-group-flush">

                    <!-- Disk Alerts -->
                    <a href="/disk"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-hdd-fill text-info me-2 fs-5"></i>
                            <span>Disk Alerts</span>
                        </div>
                        <span id="disk-alert-count"
                              class="badge rounded-pill">0</span>
                    </a>

                    <!-- Tablespace Alerts -->
                    <a href="/disk"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-database-fill text-warning me-2 fs-5"></i>
                            <span>Tablespace Alerts</span>
                        </div>
                        <span id="tablespace-alert-count"
                              class="badge rounded-pill">0</span>
                    </a>

                </div>
            </div>
        </div>

        <!-- Job Status card -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm rounded">
                <!-- Header with icon -->
                <div class="card-header bg-info text-white d-flex align-items-center">
                    <i class="bi bi-gear-fill fs-5 me-2"></i>
                    <span class="fs-6 mb-0">Job Status</span>
                </div>

                <!-- Summary counts (clickable) -->
                <div class="list-group list-group-flush">
                    <a href="/status-summary?filter=SUCCESS"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div><i class="bi bi-check-circle-fill text-success me-1"></i>Success</div>
                        <span id="job-success-count" class="badge bg-success rounded-pill">0</span>
                    </a>
                    <a href="/status-summary?filter=FAILED"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div><i class="bi bi-x-circle-fill text-danger me-1"></i>Failed</div>
                        <span id="job-fail-count" class="badge bg-danger rounded-pill">0</span>
                    </a>
                    <a href="/status-summary?filter=WAITING"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div><i class="bi bi-clock-fill text-warning me-1"></i>Waiting</div>
                        <span id="job-wait-count" class="badge bg-warning text-dark rounded-pill">0</span>
                    </a>
                </div>

                <!-- Mini trend sparkline -->
                <div class="card-body">
                    <canvas id="jobStatusChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- API Status & Charts Column -->
        <div class="col-lg-4 d-flex flex-column">
            <!-- Card A: Status List -->
            <div class="card mb-3 shadow-sm flex-fill">
                <div class="card-header bg-secondary text-white d-flex align-items-center">
                    <i class="bi bi-globe2 me-2"></i>
                    API Status
                </div>
                <ul id="api-status-list" class="list-group list-group-flush">
                    <!-- JS will inject <li> items here -->
                </ul>
            </div>

            <!-- Card B: Latency & Uptime Charts -->
            <div class="card shadow-sm flex-fill d-flex flex-column">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-bar-chart-fill me-2"></i>
                        Latency & Uptime
                    </div>
                    <select id="api-select" class="form-select form-select-sm w-auto">
                        <option value="">Select API…</option>
                        <option value="users-service">users-service</option>
                        <option value="orders-service">orders-service</option>
                        <option value="flaky-service">flaky-service</option>
                        <option value="slow-service">slow-service</option>
                        <option value="unknown-service">unknown-service</option>
                    </select>
                </div>
                <div class="card-body d-flex flex-column p-2">
                    <div class="flex-grow-2">
                        <canvas id="apiLatencyChart" style="width:100%; height: 200px;"></canvas>
                    </div>
                    <!-- 2) Uptime: take up 1/3 of the space -->
                    <div class="flex-grow-1 mt-3">
                        <canvas id="apiUptimeChart" style="width:100%; height: 100px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

    // Server & DB
    async function updateAlertCounts() {
        const diskBadge = document.getElementById('disk-alert-count');
        const dbBadge   = document.getElementById('tablespace-alert-count');

        try {
            const [diskArr, dbArr] = await Promise.all([
                fetch('/dashboard/disk').then(r => r.ok ? r.json() : []),
                fetch('/dashboard/db').then(r => r.ok ? r.json() : [])
            ]);

            const diskCount = Array.isArray(diskArr) ? diskArr.length : 0;
            const dbCount   = Array.isArray(dbArr)   ? dbArr.length   : 0;

            // Update text
            diskBadge.textContent = diskCount;
            dbBadge.textContent   = dbCount;

            // Color: red if >0, gray if 0
            diskBadge.classList.toggle('bg-danger', diskCount > 0);
            diskBadge.classList.toggle('bg-secondary', diskCount === 0);

            dbBadge.classList.toggle('bg-danger', dbCount > 0);
            dbBadge.classList.toggle('bg-secondary', dbCount === 0);

        } catch (err) {
            // On error, default to zero / gray
            diskBadge.textContent = dbBadge.textContent = '0';
            diskBadge.classList.add('bg-secondary');
            dbBadge.classList.add('bg-secondary');
        }
    }

    updateAlertCounts();
    setInterval(updateAlertCounts, 15000);

    // Job status
    async function updateJobCounts() {
        try {
            const res = await fetch('/dashboard/jobcounts');
            const json = res.ok ? await res.json() : {};
            const { successCount = 0, failCount = 0, waitCount = 0 } = json;

            document.getElementById('job-success-count').textContent = successCount;
            document.getElementById('job-fail-count').   textContent = failCount;
            document.getElementById('job-wait-count').   textContent = waitCount;
        } catch (e) {
            // on error, fallback to zeros
            document.getElementById('job-success-count').textContent = 0;
            document.getElementById('job-fail-count').   textContent = 0;
            document.getElementById('job-wait-count').   textContent = 0;
        }
    }

    // initial load + refresh every 15s
    updateJobCounts();
    setInterval(updateJobCounts, 15000);

    // Job status chart
    let jobChart;

    async function updateJobStats() {
        // 1️⃣ Fetch counts
        let success=0, fail=0, wait=0;
        try {
            const res = await fetch('/dashboard/jobcounts');
            const json = res.ok ? await res.json() : {};
            success = json.successCount || 0;
            fail    = json.failCount    || 0;
            wait    = json.waitCount    || 0;
        } catch {
            /* ignore */
        }

        // 2️⃣ Update badges
        document.getElementById('job-success-count').textContent = success;
        document.getElementById('job-fail-count').   textContent = fail;
        document.getElementById('job-wait-count').   textContent = wait;

        // 3️⃣ Init/update doughnut with explicit colors
        const ctx  = document.getElementById('jobStatusChart').getContext('2d');
        const data = [ success, fail, wait ];
        const colors = [
            '#198754', // Bootstrap --bs-success
            '#dc3545', // Bootstrap --bs-danger
            '#ffc107'  // Bootstrap --bs-warning
        ];

        if (!jobChart) {
            jobChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Success','Failed','Waiting'],
                    datasets: [{
                        data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { display: false }
                    },
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => {
                                    // context.label is “Success”/“Failed”/“Waiting”
                                    // context.parsed is the numeric count
                                    return `${context.label}: ${context.parsed}`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            jobChart.data.datasets[0].data = data;
            jobChart.update();
        }
    }

    // initial + refresh
    updateJobStats();
    setInterval(updateJobStats, 15000);

    let latencyChart, uptimeChart;

    async function updateApiCharts() {
        const apiName = document.getElementById('api-select').value;

        if (!apiName) {
            // No API selected: clear or hide the charts
            document.getElementById('apiLatencyChart').style.display = 'none';
            document.getElementById('apiUptimeChart').style.display  = 'none';
            return;
        } else {
            // API is selected: make sure they’re visible
            document.getElementById('apiLatencyChart').style.display = '';
            document.getElementById('apiUptimeChart').style.display  = '';
        }

        const url     = '/dashboard/apimetrics'
            + (apiName ? `?apiName=${encodeURIComponent(apiName)}` : '');

        let json = {};
        try {
            const res = await fetch(url);
            json = res.ok ? await res.json() : {};
        } catch (e) {
            console.error('API metrics fetch failed', e);
        }

        const labels      = json.labels        || [];
        const latencyData = json.latencySeries || [];
        const uptimeData  = json.uptimeSeries  || [];

        // —— Latency line chart ——
        const ctxL = document.getElementById('apiLatencyChart').getContext('2d');
        if (!latencyChart) {
            latencyChart = new Chart(ctxL, {
                type: 'line',
                data: { labels, datasets: [{
                        label: apiName || 'All APIs',
                        data: latencyData,
                        borderColor: '#0d6efd',
                        fill: false,
                        pointRadius: 2,
                        tension: 0.3
                    }]},
                options: {
                    responsive: true,
                    scales: {
                        x: { display: false },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Latency (ms)'         // ← axis title
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: { label: ctx => `${ctx.parsed.y} ms` }
                        }
                    }
                }
            });
        } else {
            latencyChart.data.labels              = labels;
            latencyChart.data.datasets[0].data    = latencyData;
            latencyChart.data.datasets[0].label   = apiName || 'All APIs';
            latencyChart.update();
        }

        // —— Uptime step chart ——
        const ctxU = document.getElementById('apiUptimeChart').getContext('2d');

        if (!uptimeChart) {
            uptimeChart = new Chart(ctxU, {
                type: 'line',
                data: { labels, datasets: [{
                        label: apiName || 'All APIs',
                        data: uptimeData,
                        borderColor: '#198754',
                        stepped: true,
                        fill: false,
                        pointRadius: 0
                    }]},
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Job Status'
                            },
                            min: 0,
                            max: 1,
                            ticks: {
                                stepSize: 1,
                                callback: v => v === 1 ? 'Up' : 'Down',
                                font: { size: 12 }
                            },
                            grid: {drawBorder: false}
                        },
                        x: {display: false}

                    },
                    plugins: { legend: { display: false } }
                }
            });
        } else {
            uptimeChart.data.labels           = labels;
            uptimeChart.data.datasets[0].data = uptimeData;
            uptimeChart.update();
        }
    }

    // Re‐draw on change + auto‐refresh
    document.getElementById('api-select')
        .addEventListener('change', updateApiCharts);

    updateApiCharts();
    setInterval(updateApiCharts, 15000);

    let firstLoad = true;
    async function updateApiStatusList() {
        const list = document.getElementById('api-status-list');
        const apis = await fetch('/dashboard/apistatus')
            .then(r => r.ok ? r.json() : []);
        list.innerHTML = apis.length
            ? apis.map(api => `
        <a
          href="/api-summary?apiName=${encodeURIComponent(api.apiName)}"
          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
        >
          <div>
            <strong>${api.apiName}</strong>
            <small class="text-muted ms-2">${api.latencyMillis ?? '–'} ms</small>
          </div>
          <span class="badge ${api.up ? 'bg-success' : 'bg-danger'} rounded-pill">
            ${api.up ? 'Up' : 'Down'}
          </span>
        </a>
      `).join('')
            : '<div class="p-3 text-muted">No APIs configured</div>';
    }
    updateApiStatusList();
    setInterval(updateApiStatusList, 30000);

</script>
</body>
</html>
